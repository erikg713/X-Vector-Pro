import os
import importlib

def load_exploits(filter_tags=None, only_enabled=True):
    modules = []
    exploits_dir = os.path.dirname(__file__)
    for file in os.listdir(exploits_dir):
        if file.endswith(".py") and file != "__init__.py":
            name = file[:-3]
            try:
                mod = importlib.import_module(f"exploits.{name}")

                # Check if module has 'metadata'
                if not hasattr(mod, "metadata"):
                    print(f"[!] Exploit {name} missing metadata, skipping.")
                    continue

                meta = mod.metadata

                # Skip if disabled
                if only_enabled and not meta.get("enabled", False):
                    continue

                # Filter by tags if specified
                if filter_tags:
                    exploit_tags = meta.get("tags", [])
                    if not any(tag in exploit_tags for tag in filter_tags):
                        continue

                modules.append((meta.get("name", name), mod))
            except Exception as e:
                print(f"[!] Failed to load exploit {name}: {e}")
    return modules

def run_all_exploits(target_url, filter_tags=None):
    results = []
    exploits = load_exploits(filter_tags=filter_tags)

    for name, mod in exploits:
        print(f"[*] Running exploit: {name}")
        try:
            result = mod.run_exploit(target_url)
            results.append((name, result))
        except Exception as e:
            print(f"[!] Exploit {name} failed: {e}")
            results.append((name, None))

    return results
